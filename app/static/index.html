<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Zapchat CRM Premium</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f5f7fa; font-family: Arial, sans-serif; }
    .card { border: none; box-shadow: 0 3px 8px rgba(0,0,0,0.08); }
    h4 { color: #0d6efd; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Zapchat CRM</h1>
      <div>
        <small class="text-muted">Single admin: admin / 1234</small>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-md-4">
        <div class="card p-3">
          <h4>Mijozlar</h4>
          <form id="customerForm" class="mb-2">
            <input id="cust_name" class="form-control mb-2" placeholder="Ism familiya" required>
            <input id="cust_phone" class="form-control mb-2" placeholder="Telefon">
            <input id="cust_addr" class="form-control mb-2" placeholder="Manzil">
            <button class="btn btn-primary w-100">Qo\'shish</button>
          </form>
          <ul id="customers" class="list-group"></ul>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <h4>Zapchastlar</h4>
          <form id="partForm" class="mb-2">
            <input id="part_name" class="form-control mb-2" placeholder="Nomi" required>
            <input id="part_price" type="number" class="form-control mb-2" placeholder="Narxi" required>
            <input id="part_qty" type="number" class="form-control mb-2" placeholder="Miqdor" required>
            <button class="btn btn-success w-100">Qo\'shish</button>
          </form>
          <ul id="parts" class="list-group"></ul>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <h4>Buyurtmalar va Statistika</h4>
          <form id="orderForm" class="mb-2">
            <select id="order_customer" class="form-select mb-2" required></select>
            <select id="order_part" class="form-select mb-2" required></select>
            <input id="order_qty" type="number" class="form-control mb-2" value="1">
            <button class="btn btn-warning w-100">Buyurtma</button>
          </form>
          <hr>
          <div id="stats" class="mb-2"></div>
          <ul id="orders" class="list-group"></ul>
        </div>
      </div>
    </div>
  </div>

<script>
const API = location.origin;

async function loadCustomers(){
  const res = await fetch(API + '/customers');
  const arr = await res.json();
  const ul = document.getElementById('customers');
  const sel = document.getElementById('order_customer');
  ul.innerHTML=''; sel.innerHTML = '<option value="">Mijoz tanlang</option>';
  arr.forEach(c => {
    ul.innerHTML += `<li class="list-group-item d-flex justify-content-between">${c.full_name}<button class="btn btn-sm btn-danger" onclick="delCustomer(${c.id})">O'chirish</button></li>`;
    sel.innerHTML += `<option value="${c.id}">${c.full_name}</option>`;
  });
}

async function delCustomer(id){
  await fetch(API + '/customers/' + id, {method:'DELETE'});
  loadCustomers(); loadOrders(); loadStats();
}

async function loadParts(){
  const res = await fetch(API + '/parts');
  const arr = await res.json();
  const ul = document.getElementById('parts');
  const sel = document.getElementById('order_part');
  ul.innerHTML=''; sel.innerHTML = '<option value="">Zapchast tanlang</option>';
  arr.forEach(p => {
    ul.innerHTML += `<li class="list-group-item d-flex justify-content-between">${p.name} (${p.quantity}) <button class="btn btn-sm btn-danger" onclick="delPart(${p.id})">O'chirish</button></li>`;
    sel.innerHTML += `<option value="${p.id}">${p.name} - ${p.quantity} dona</option>`;
  });
}

async function delPart(id){
  await fetch(API + '/parts/' + id, {method:'DELETE'});
  loadParts(); loadOrders(); loadStats();
}

async function loadOrders(){
  const res = await fetch(API + '/orders');
  const arr = await res.json();
  const ul = document.getElementById('orders');
  ul.innerHTML='';
  arr.forEach(o => {
    ul.innerHTML += `<li class="list-group-item">#${o.id} | Mijoz:${o.customer_id} | Sum:${o.total_amount.toFixed(2)} <button class="btn btn-sm btn-danger" onclick="delOrder(${o.id})">O'chirish</button></li>`;
  });
}

async function delOrder(id){
  await fetch(API + '/orders/' + id, {method:'DELETE'});
  loadOrders(); loadParts(); loadStats();
}

async function loadStats(){
  const res = await fetch(API + '/stats/summary');
  const j = await res.json();
  document.getElementById('stats').innerHTML = `<b>Buyurtma:</b> ${j.total_orders} — <b>Daromad:</b> ${j.total_revenue.toFixed(2)} — <b>Ombor qiymati:</b> ${j.stock_value.toFixed(2)}`;
}

document.getElementById('customerForm').addEventListener('submit', async e => {
  e.preventDefault();
  await fetch(API + '/customers', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ full_name: document.getElementById('cust_name').value, phone: document.getElementById('cust_phone').value, address: document.getElementById('cust_addr').value })
  });
  e.target.reset(); loadCustomers(); loadStats();
});

document.getElementById('partForm').addEventListener('submit', async e => {
  e.preventDefault();
  await fetch(API + '/parts', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ name: document.getElementById('part_name').value, price: parseFloat(document.getElementById('part_price').value), quantity: parseInt(document.getElementById('part_qty').value) })
  });
  e.target.reset(); loadParts(); loadStats();
});

document.getElementById('orderForm').addEventListener('submit', async e => {
  e.preventDefault();
  const cid = parseInt(document.getElementById('order_customer').value);
  const pid = parseInt(document.getElementById('order_part').value);
  const qty = parseInt(document.getElementById('order_qty').value);
  await fetch(API + '/orders', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ customer_id: cid, items: [{ part_id: pid, qty: qty }] })
  });
  e.target.reset(); loadOrders(); loadParts(); loadStats();
});

loadCustomers(); loadParts(); loadOrders(); loadStats();
</script>
</body>
</html>
